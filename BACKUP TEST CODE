// ===== ì´ë©”ì¼ ì„¤ì • =====
// ë°©ë²• 1: ì—¬ê¸°ì— ì§ì ‘ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”
const NOTIFICATION_EMAIL = "youngjoonkim@kas.co.kr"; // ì›í•˜ëŠ” ì´ë©”ì¼ ì£¼ì†Œë¡œ ë³€ê²½

// ë°©ë²• 2: ì—¬ëŸ¬ ê°œì˜ ì´ë©”ì¼ë¡œ ë°›ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ì²˜ëŸ¼ ì„¤ì •
const NOTIFICATION_EMAILS = ["shlee@kas.co.kr", "jejukim54@naver.com", "kunspark@kas.co.kr", "hseongkim@kas.co.kr", "kyuwlee@kas.co.kr", "hyukkim@kas.co.kr"];

// ë°©ë²• 3: ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì˜ íŠ¹ì • ì…€ì—ì„œ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì½ì–´ì˜¤ê¸°
// ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì˜ K1 ì…€ì— ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤
function getEmailFromSheet() {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    const emailCell = sheet.getRange("K1").getValue();
    if (emailCell && emailCell.includes("@")) {
      return emailCell;
    }
  } catch (error) {
    Logger.log("Could not read email from sheet: " + error.toString());
  }
  return null;
}

// ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ì´ë©”ì¼ ì„¤ì • ì•ˆë‚´ ì¶”ê°€
function setupEmailCell() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();

  // K1 ì…€ì— ì•ˆë‚´ í…ìŠ¤íŠ¸ ì¶”ê°€
  if (!sheet.getRange("K1").getValue()) {
    sheet.getRange("K1").setValue("ì´ë©”ì¼ì£¼ì†Œ ì…ë ¥");
    sheet.getRange("K1").setBackground("#f0f0f0");
    sheet.getRange("K1").setFontWeight("bold");
    sheet.getRange("J1").setValue("ì•Œë¦¼ ì´ë©”ì¼:");
    sheet.getRange("J1").setFontWeight("bold");
  }
}

// ë§ˆì§€ë§‰ ì´ë©”ì¼ ë°œì†¡ ì‹œê°„ í™•ì¸ ë° ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function canSendEmail() {
  const properties = PropertiesService.getScriptProperties();
  const lastEmailTime = properties.getProperty('LAST_EMAIL_TIME');
  const now = new Date().getTime();
  
  if (!lastEmailTime) {
    // ì²˜ìŒ ë°œì†¡í•˜ëŠ” ê²½ìš°
    properties.setProperty('LAST_EMAIL_TIME', now.toString());
    return true;
  }
  
  const timeDiff = now - parseInt(lastEmailTime);
  const thirtyMinutes = 30 * 60 * 1000; // 30ë¶„ì„ ë°€ë¦¬ì´ˆë¡œ ë³€í™˜
  
  if (timeDiff >= thirtyMinutes) {
    // 30ë¶„ì´ ì§€ë‚¬ìœ¼ë©´ ë°œì†¡ ê°€ëŠ¥
    properties.setProperty('LAST_EMAIL_TIME', now.toString());
    return true;
  }
  
  return false; // 30ë¶„ì´ ì•ˆ ì§€ë‚¬ìœ¼ë©´ ë°œì†¡ ë¶ˆê°€
}

// ë§ˆì§€ë§‰ ì´ë©”ì¼ ë°œì†¡ ì‹œê°„ ì´ˆê¸°í™” í•¨ìˆ˜ (í…ŒìŠ¤íŠ¸ìš©)
function resetEmailTimer() {
  const properties = PropertiesService.getScriptProperties();
  properties.deleteProperty('LAST_EMAIL_TIME');
  Logger.log("ì´ë©”ì¼ ë°œì†¡ íƒ€ì´ë¨¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
}

function fetchWeatherData() {
  const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = spreadsheet.getActiveSheet();

  // ì²« ì‹¤í–‰ ì‹œ ì´ë©”ì¼ ì„¤ì • ì…€ ì¤€ë¹„
  setupEmailCell();

  const baseUrl = "https://www.weather.go.kr/w/observation/land/aws-obs.do";
  const now = new Date();
  const params = {
    'db': 'MINDB_01M',
    'tm': Utilities.formatDate(now, "Asia/Seoul", "yyyy.MM.dd%20HH:mm"),
    'stnId': '890',
    'sidoCode': '5000000000'
  };

  const url = baseUrl + "?" + Object.entries(params)
    .map(([key, value]) => `${key}=${value}`)
    .join("&");

  try {
    const response = UrlFetchApp.fetch(url);
    const html = response.getContentText();
    Logger.log("HTML received. Length: " + html.length);

    // í—¤ë”ê°€ ì—†ì„ ê²½ìš° ì¶”ê°€
    if (sheet.getLastRow() === 0) {
      sheet.appendRow([
        "ì‹œê°„",
        "ìŠµë„(%)",
        "ê¸°ì˜¨(Â°C)",
        "ì²´ê°ì˜¨ë„(Â°C)",
        "ê°•ìˆ˜ìœ ë¬´",
        "1ì‹œê°„ê°•ìˆ˜(mm)",
        "ì¼ê°•ìˆ˜(mm)",
        "10ë¶„í’í–¥",
        "10ë¶„í’ì†(m/s)"
      ]);
    }

    const newData = parseWeatherTable(html, now);

    if (newData && newData.length > 0) {
      // ê°€ì¥ ìµœì‹  ë°ì´í„°ë§Œ ê°€ì ¸ì˜´ (ì²« ë²ˆì§¸ í–‰)
      const latestData = newData[0];

      // ê¸°ì¡´ ë°ì´í„°ì˜ ìµœì‹  ì‹œê°„ í™•ì¸ (ë‘ ë²ˆì§¸ í–‰)
      let lastRecordedTime = "";
      if (sheet.getLastRow() > 1) {
        lastRecordedTime = sheet.getRange(2, 1).getValue();
      }

      // ìµœì‹  ë°ì´í„°ì˜ ì‹œê°„ì´ ë‹¤ë¥¸ ê²½ìš°ì—ë§Œ ì¶”ê°€
      if (latestData[0] !== lastRecordedTime) {
        sheet.insertRowAfter(1);
        sheet.getRange(2, 1, 1, latestData.length).setValues([latestData]);
        Logger.log(`Added new data: ${latestData[0]} - ì²´ê°ì˜¨ë„: ${latestData[3]}Â°C`);

        // ì²´ê°ì˜¨ë„ í™•ì¸ ë° ì´ë©”ì¼ ë°œì†¡
        checkTemperatureAndSendEmail(latestData);
      } else {
        Logger.log("No new data to add - same time as last record");
      }
    }

  } catch (error) {
    Logger.log("Error: " + error.toString());
  }
}

function checkTemperatureAndSendEmail(rowData) {
  const time = rowData[0];
  const feelsLike = parseFloat(rowData[3]); // ì²´ê°ì˜¨ë„

  // ì²´ê°ì˜¨ë„ê°€ 31ë„ ì´ìƒì´ë©´ì„œ 30ë¶„ ê°„ê²©ì´ ì§€ë‚¬ì„ ë•Œë§Œ ì´ë©”ì¼ ë°œì†¡
  if (feelsLike >= 31) {
    // 30ë¶„ ê°„ê²© ì²´í¬
    if (!canSendEmail()) {
      Logger.log(`ì²´ê°ì˜¨ë„ ${feelsLike}Â°C - 30ë¶„ ë¯¸ê²½ê³¼ë¡œ ì´ë©”ì¼ ë¯¸ë°œì†¡`);
      return;
    }

    const humidity = rowData[1];
    const temperature = rowData[2];
    const rain = rowData[4];
    const windSpeed = rowData[8];

    // ì²´ê°ì˜¨ë„ êµ¬ê°„ë³„ íœ´ì‹ ì‹œê°„ ì„¤ì •
    let restTime = "";
    if (feelsLike >= 33) {
      restTime = "2ì‹œê°„ ê·¼ë¬´ì‹œ 20ë¶„ íœ´ì‹";
    } else {
      restTime = "2ì‹œê°„ ê·¼ë¬´ì‹œ 10ë¶„ íœ´ì‹";
    }

    const subject = `[ê¸°ìƒê²½ë³´] ì²´ê°ì˜¨ë„ ${feelsLike}Â°C - ì£¼ì˜ í•„ìš”`;
    const body = `
ê¸°ìƒ ê²½ë³´ ì•Œë¦¼

ì¸¡ì • ì‹œê°„: ${time}
ê¸°ì˜¨: ${temperature}Â°C
ì²´ê°ì˜¨ë„: ${feelsLike}Â°C
ìŠµë„: ${humidity}%
í’ì†: ${windSpeed}m/s
ê°•ìˆ˜ìœ ë¬´: ${rain}

ì²´ê°ì˜¨ë„ê°€ ${feelsLike >= 33 ? '33' : '31'}ë„ ì´ìƒì…ë‹ˆë‹¤. 
- ì™¸ì¶œ ì‹œ ì¶©ë¶„í•œ ìˆ˜ë¶„ ì„­ì·¨
- ì§ì‚¬ê´‘ì„  í”¼í•˜ê¸°
- ë¬´ë¦¬í•œ ì•¼ì™¸í™œë™ ìì œ

${restTime}


ê±´ê°•ì— ìœ ì˜í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.
    `;

    // ì´ë©”ì¼ ìˆ˜ì‹ ì ì„¤ì • (ìš°ì„ ìˆœìœ„: ìŠ¤í”„ë ˆë“œì‹œíŠ¸ â†’ ì½”ë“œ ì„¤ì • â†’ í˜„ì¬ ì‚¬ìš©ì)
    let recipient = getEmailFromSheet() || NOTIFICATION_EMAIL;
    if (!recipient || recipient === "your-email@example.com") {
      recipient = Session.getActiveUser().getEmail();
    }

    try {
      // í•œ ëª…ì—ê²Œ ë°œì†¡
      MailApp.sendEmail(recipient, subject, body);
      Logger.log(`Email sent to ${recipient} for temperature alert: ${feelsLike}Â°C (${alertLevel}) at ${time}`);

      // ì—¬ëŸ¬ ëª…ì—ê²Œ ë°œì†¡í•˜ë ¤ë©´ ì•„ë˜ ì½”ë“œ ì‚¬ìš©
      if (typeof NOTIFICATION_EMAILS !== 'undefined' && NOTIFICATION_EMAILS.length > 0) {
         NOTIFICATION_EMAILS.forEach(email => {
           MailApp.sendEmail(email, subject, body);
          Logger.log(`Email sent to ${email}`);
        });
       }
    } catch (error) {
      Logger.log(`Failed to send email: ${error.toString()}`);
    }
  } else {
    Logger.log(`ì²´ê°ì˜¨ë„ ${feelsLike}Â°C - 31ë„ ë¯¸ë§Œìœ¼ë¡œ ì•Œë¦¼ ë¯¸ë°œì†¡`);
  }
}

function parseWeatherTable(html, currentDate) {
  const tableData = [];

  try {
    const trRegex = /<tr>\s*<td[^>]*class="aws-table[^>]*>.*?<\/tr>/gs;
    const rows = html.match(trRegex);

    if (rows) {
      Logger.log(`Found ${rows.length} rows`);

      // í˜„ì¬ ë‚ ì§œ í¬ë§·íŒ…
      const year = currentDate.getFullYear();
      const month = String(currentDate.getMonth() + 1).padStart(2, '0');
      const day = String(currentDate.getDate()).padStart(2, '0');
      const dateStr = `${year}-${month}-${day}`;

      rows.forEach(row => {
        const timeMatch = row.match(/<td[^>]*><span>(\d{2}:\d{2})<\/span>/);
        if (!timeMatch) return;

        const time = timeMatch[1];
        const fullDateTime = `${dateStr} ${time}`; // ì—°ë„-ì›”-ì¼ ì‹œ:ë¶„ í˜•ì‹

        const rainMatch = row.match(/pty-(\w+)/);
        const rainStatus = rainMatch ? (rainMatch[1] === 'off' ? 'X' : 'O') : '';

        const values = [];
        const tdRegex = /<td[^>]*class="aws-table[^>]*>(?:<span[^>]*>)?([^<]+)(?:<\/span>)?<\/td>/g;
        let match;
        while ((match = tdRegex.exec(row)) !== null) {
          values.push(match[1].trim());
        }

        const windSpeeds = [];
        const windSpeedRegex = /<span data-role="aws-wind-speed-value">([^<]+)<\/span>/g;
        while ((match = windSpeedRegex.exec(row)) !== null) {
          windSpeeds.push(match[1]);
        }

        const rowData = [
          fullDateTime,           // Aì—´: ì‹œê°„ (ì—°ë„-ì›”-ì¼ í¬í•¨)
          values[10],             // Bì—´: ìŠµë„
          values[4],              // Cì—´: ê¸°ì˜¨
          values[5],              // Dì—´: ì²´ê°ì˜¨ë„
          rainStatus,             // Eì—´: ê°•ìˆ˜ìœ ë¬´
          values[2],              // Fì—´: 1ì‹œê°„ê°•ìˆ˜
          values[3],              // Gì—´: ì¼ê°•ìˆ˜
          values[6],              // Hì—´: 10ë¶„í’í–¥
          windSpeeds[0]           // Iì—´: 10ë¶„í’ì†
        ];

        if (fullDateTime && rowData.some(value => value !== undefined)) {
          tableData.push(rowData);
        }
      });
    }
  } catch (error) {
    Logger.log("Parsing Error: " + error.toString());
    return null;
  }

  return tableData;
}

// ë°ì´í„° ì •ë¦¬ í•¨ìˆ˜ (ì„ íƒì‚¬í•­ - ì˜¤ë˜ëœ ë°ì´í„° ì‚­ì œ)
// 30ì¼ ì´ìƒ ëœ ë°ì´í„°ë¥¼ ìë™ìœ¼ë¡œ ì‚­ì œí•©ë‹ˆë‹¤
// í•„ìš”ì—†ìœ¼ë©´ ì´ í•¨ìˆ˜ì™€ ê´€ë ¨ íŠ¸ë¦¬ê±°ë¥¼ ì‚­ì œí•˜ì„¸ìš”
function cleanOldData() {
  const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = spreadsheet.getActiveSheet();

  if (sheet.getLastRow() <= 1) return;

  const daysToKeep = 720; // ë³´ê´€ ê¸°ê°„ (ì¼) - í•„ìš”ì— ë”°ë¼ ì¡°ì •
  const cutoffDate = new Date();
  cutoffDate.setDate(cutoffDate.getDate() - daysToKeep);

  const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 1).getValues();
  let rowsToDelete = [];

  for (let i = data.length - 1; i >= 0; i--) {
    const dateTime = new Date(data[i][0]);
    if (dateTime < cutoffDate) {
      rowsToDelete.push(i + 2); // ì‹¤ì œ í–‰ ë²ˆí˜¸ (í—¤ë” í¬í•¨)
    }
  }

  // ì•„ë˜ì—ì„œë¶€í„° ì‚­ì œ (ì¸ë±ìŠ¤ê°€ ë³€ê²½ë˜ì§€ ì•Šë„ë¡)
  rowsToDelete.forEach(row => {
    sheet.deleteRow(row);
  });

  if (rowsToDelete.length > 0) {
    Logger.log(`Deleted ${rowsToDelete.length} old records (older than ${daysToKeep} days)`);
  }
}

function createTrigger() {
  deleteTriggers();

  // 10ë¶„ë§ˆë‹¤ ë‚ ì”¨ ë°ì´í„° ìˆ˜ì§‘
  ScriptApp.newTrigger('fetchWeatherData')
    .timeBased()
    .everyMinutes(10)
    .create();

  // ë§¤ì¼ ìƒˆë²½ 3ì‹œì— 30ì¼ ì´ìƒ ëœ ë°ì´í„° ì •ë¦¬ (ì„ íƒì‚¬í•­)
  // í•„ìš”ì—†ìœ¼ë©´ ì´ ë¶€ë¶„ì€ ì£¼ì„ì²˜ë¦¬í•˜ê±°ë‚˜ ì‚­ì œí•˜ì„¸ìš”
  ScriptApp.newTrigger('cleanOldData')
    .timeBased()
    .everyDays(1)
    .atHour(3)
    .create();

  Logger.log("Triggers created: 10ë¶„ë§ˆë‹¤ ë°ì´í„° ìˆ˜ì§‘, ë§¤ì¼ ìƒˆë²½ 3ì‹œ ì˜¤ë˜ëœ ë°ì´í„° ì •ë¦¬");
}

function deleteTriggers() {
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => ScriptApp.deleteTrigger(trigger));
}

function manualRun() {
  Logger.log("Manual execution started");
  fetchWeatherData();
  Logger.log("Manual execution completed");
}

// ì´ë©”ì¼ ë°œì†¡ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ (31ë„ë¡œ ìˆ˜ì •)
function testEmailAlert() {
  // í…ŒìŠ¤íŠ¸ìš© ë°ì´í„° ìƒì„± (ì²´ê°ì˜¨ë„ 31ë„ ì´ìƒ)
  const now = new Date();
  const testData = [
    Utilities.formatDate(now, "Asia/Seoul", "yyyy-MM-dd HH:mm"),
    "75",     // ìŠµë„
    "29",     // ê¸°ì˜¨
    "32.5",   // ì²´ê°ì˜¨ë„ (31ë„ ì´ìƒìœ¼ë¡œ ì„¤ì •)
    "X",      // ê°•ìˆ˜ìœ ë¬´
    "0",      // 1ì‹œê°„ê°•ìˆ˜
    "0",      // ì¼ê°•ìˆ˜
    "ë‚¨ì„œ",   // 10ë¶„í’í–¥
    "2.5"     // 10ë¶„í’ì†
  ];

  // ì‹¤ì œë¡œ ì‚¬ìš©ë  ì´ë©”ì¼ ì£¼ì†Œ í™•ì¸
  const sheetEmail = getEmailFromSheet();
  const codeEmail = (NOTIFICATION_EMAIL !== "your-email@example.com") ? NOTIFICATION_EMAIL : null;
  const recipient = sheetEmail || codeEmail || Session.getActiveUser().getEmail();

  Logger.log("í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±:");
  Logger.log(`ì‹œê°„: ${testData[0]}`);
  Logger.log(`ì²´ê°ì˜¨ë„: ${testData[3]}Â°C`);
  Logger.log(`ìˆ˜ì‹  ì´ë©”ì¼: ${recipient}`);

  // í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ íƒ€ì´ë¨¸ ì´ˆê¸°í™”
  resetEmailTimer();

  // ì´ë©”ì¼ ë°œì†¡ í•¨ìˆ˜ í˜¸ì¶œ
  try {
    checkTemperatureAndSendEmail(testData);
    Logger.log("í…ŒìŠ¤íŠ¸ ì´ë©”ì¼ ë°œì†¡ ì™„ë£Œ!");

    // ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— í…ŒìŠ¤íŠ¸ ë°ì´í„° ì¶”ê°€ (ì„ íƒì‚¬í•­)
    const addToSheet = Browser.msgBox(
      "í…ŒìŠ¤íŠ¸ ë°ì´í„° ì¶”ê°€",
      "í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì—ë„ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
      Browser.Buttons.YES_NO
    );

    if (addToSheet === Browser.Buttons.YES) {
      const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
      const sheet = spreadsheet.getActiveSheet();

      // í—¤ë”ê°€ ì—†ìœ¼ë©´ ì¶”ê°€
      if (sheet.getLastRow() === 0) {
        sheet.appendRow([
          "ì‹œê°„",
          "ìŠµë„(%)",
          "ê¸°ì˜¨(Â°C)",
          "ì²´ê°ì˜¨ë„(Â°C)",
          "ê°•ìˆ˜ìœ ë¬´",
          "1ì‹œê°„ê°•ìˆ˜(mm)",
          "ì¼ê°•ìˆ˜(mm)",
          "10ë¶„í’í–¥",
          "10ë¶„í’ì†(m/s)"
        ]);
      }

      // í…ŒìŠ¤íŠ¸ ë°ì´í„° ì¶”ê°€
      sheet.insertRowAfter(1);
      sheet.getRange(2, 1, 1, testData.length).setValues([testData]);
      sheet.getRange(2, 1, 1, 9).setBackground("#ffe6e6"); // í…ŒìŠ¤íŠ¸ ë°ì´í„° í‘œì‹œìš© ë°°ê²½ìƒ‰

      Logger.log("í…ŒìŠ¤íŠ¸ ë°ì´í„°ê°€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }
  } catch (error) {
    Logger.log(`ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨: ${error.toString()}`);
  }
}

// ë‹¤ì–‘í•œ ì˜¨ë„ë¡œ ì—¬ëŸ¬ ê°œì˜ í…ŒìŠ¤íŠ¸ ì´ë©”ì¼ ë°œì†¡
function testMultipleTemperatures() {
  const temperatures = [29, 31, 33, 34]; // í…ŒìŠ¤íŠ¸í•  ì²´ê°ì˜¨ë„ë“¤

  // íƒ€ì´ë¨¸ ì´ˆê¸°í™”
  resetEmailTimer();

  temperatures.forEach((temp, index) => {
    const now = new Date();
    now.setMinutes(now.getMinutes() - index * 10); // ì‹œê°„ì„ ë‹¤ë¥´ê²Œ ì„¤ì •

    const testData = [
      Utilities.formatDate(now, "Asia/Seoul", "yyyy-MM-dd HH:mm"),
      "80",           // ìŠµë„
      String(temp - 3), // ê¸°ì˜¨ (ì²´ê°ì˜¨ë„ë³´ë‹¤ 3ë„ ë‚®ê²Œ)
      String(temp),   // ì²´ê°ì˜¨ë„
      "X",            // ê°•ìˆ˜ìœ ë¬´
      "0",            // 1ì‹œê°„ê°•ìˆ˜
      "0",            // ì¼ê°•ìˆ˜
      "ë‚¨ì„œ",         // 10ë¶„í’í–¥
      "3.0"           // 10ë¶„í’ì†
    ];

    Logger.log(`\ní…ŒìŠ¤íŠ¸ ${index + 1}: ì²´ê°ì˜¨ë„ ${temp}Â°C`);

    // 31ë„ ì´ìƒì¸ ê²½ìš°ë§Œ ì´ë©”ì¼ ë°œì†¡ (ì²« ë²ˆì§¸ë§Œ ë°œì†¡, ë‚˜ë¨¸ì§€ëŠ” 30ë¶„ ì œí•œ)
    if (temp >= 31) {
      if (index === 1) { // 31ë„ í…ŒìŠ¤íŠ¸ë§Œ ë°œì†¡ (ì²« ë²ˆì§¸)
        checkTemperatureAndSendEmail(testData);
        Logger.log(`â†’ ì´ë©”ì¼ ë°œì†¡ë¨ (ì²´ê°ì˜¨ë„: ${temp}Â°C)`);
        // ë‹¤ìŒ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ 31ë¶„ í›„ ì‹œê°„ìœ¼ë¡œ ì„¤ì •
        const properties = PropertiesService.getScriptProperties();
        const futureTime = new Date().getTime() - (31 * 60 * 1000);
        properties.setProperty('LAST_EMAIL_TIME', futureTime.toString());
      } else {
        checkTemperatureAndSendEmail(testData);
        Logger.log(`â†’ ì´ë©”ì¼ ë°œì†¡ ì‹œë„ (ì²´ê°ì˜¨ë„: ${temp}Â°C)`);
      }
    } else {
      Logger.log(`â†’ ì´ë©”ì¼ ë¯¸ë°œì†¡ (ì²´ê°ì˜¨ë„: ${temp}Â°C, 31ë„ ë¯¸ë§Œ)`);
    }

    // ì´ë©”ì¼ ë°œì†¡ ê°„ê²©ì„ ë‘ê¸° ìœ„í•œ ëŒ€ê¸°
    Utilities.sleep(1000); // 1ì´ˆ ëŒ€ê¸°
  });

  Logger.log("\nëª¨ë“  í…ŒìŠ¤íŠ¸ ì™„ë£Œ!");
}

// ì´ë©”ì¼ ì„¤ì • í™•ì¸ í•¨ìˆ˜
function checkEmailSettings() {
  const defaultEmail = Session.getActiveUser().getEmail();
  const sheetEmail = getEmailFromSheet();
  const codeEmail = (NOTIFICATION_EMAIL !== "your-email@example.com") ? NOTIFICATION_EMAIL : null;
  const configuredEmail = sheetEmail || codeEmail || defaultEmail;
  const remainingQuota = MailApp.getRemainingDailyQuota();

  // ë§ˆì§€ë§‰ ì´ë©”ì¼ ë°œì†¡ ì‹œê°„ í™•ì¸
  const properties = PropertiesService.getScriptProperties();
  const lastEmailTime = properties.getProperty('LAST_EMAIL_TIME');
  let lastEmailDate = "ì—†ìŒ";
  if (lastEmailTime) {
    lastEmailDate = new Date(parseInt(lastEmailTime)).toLocaleString('ko-KR');
  }

  Logger.log("=== ì´ë©”ì¼ ì„¤ì • ì •ë³´ ===");
  Logger.log(`í˜„ì¬ ë¡œê·¸ì¸ ê³„ì •: ${defaultEmail}`);
  Logger.log(`ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì„¤ì • (K1 ì…€): ${sheetEmail || "ì—†ìŒ"}`);
  Logger.log(`ì½”ë“œ ë‚´ ì„¤ì •: ${codeEmail || "ì—†ìŒ"}`);
  Logger.log(`ìµœì¢… ì‚¬ìš©ë  ì´ë©”ì¼: ${configuredEmail}`);
  Logger.log(`ì˜¤ëŠ˜ ë‚¨ì€ ì´ë©”ì¼ ë°œì†¡ ê°€ëŠ¥ íšŸìˆ˜: ${remainingQuota}`);
  Logger.log(`ë§ˆì§€ë§‰ ì´ë©”ì¼ ë°œì†¡ ì‹œê°„: ${lastEmailDate}`);

  // ì—¬ëŸ¬ ì´ë©”ì¼ ì„¤ì •ì´ ìˆëŠ” ê²½ìš°
  if (typeof NOTIFICATION_EMAILS !== 'undefined' && NOTIFICATION_EMAILS.length > 0) {
    Logger.log(`ë‹¤ì¤‘ ìˆ˜ì‹ ì ì„¤ì •: ${NOTIFICATION_EMAILS.join(', ')}`);
  }

  // í…ŒìŠ¤íŠ¸ ì´ë©”ì¼ ë°œì†¡
  try {
    MailApp.sendEmail(
      configuredEmail,
      "[í…ŒìŠ¤íŠ¸] ê¸°ìƒ ì•Œë¦¼ ì‹œìŠ¤í…œ ì‘ë™ í™•ì¸ (31ë„ ê¸°ì¤€)",
      "ì´ ì´ë©”ì¼ì€ ê¸°ìƒ ì•Œë¦¼ ì‹œìŠ¤í…œì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•˜ëŠ” í…ŒìŠ¤íŠ¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.\n\n" +
      "ì²´ê°ì˜¨ë„ê°€ 31ë„ ì´ìƒì¼ ë•Œ 30ë¶„ ê°„ê²©ìœ¼ë¡œ ì´ì™€ ê°™ì€ í˜•ì‹ìœ¼ë¡œ ì•Œë¦¼ ì´ë©”ì¼ì´ ë°œì†¡ë©ë‹ˆë‹¤.\n\n" +
      "ì•Œë¦¼ ê¸°ì¤€:\n" +
      "â€¢ 31ë„ ì´ìƒ 33ë„ ë¯¸ë§Œ: 2ì‹œê°„ ê·¼ë¬´ì‹œ 10ë¶„ íœ´ì‹\n" +
      "â€¢ 33ë„ ì´ìƒ: 2ì‹œê°„ ê·¼ë¬´ì‹œ 20ë¶„ íœ´ì‹\n\n" +
      `ì´ë©”ì¼ ì„¤ì • ìš°ì„ ìˆœìœ„:\n` +
      `1. ìŠ¤í”„ë ˆë“œì‹œíŠ¸ K1 ì…€: ${sheetEmail || "ì„¤ì • ì•ˆë¨"}\n` +
      `2. ì½”ë“œ ë‚´ ì„¤ì •: ${codeEmail || "ì„¤ì • ì•ˆë¨"}\n` +
      `3. ê¸°ë³¸ê°’ (ë¡œê·¸ì¸ ê³„ì •): ${defaultEmail}\n\n` +
      `í˜„ì¬ ì‚¬ìš© ì¤‘: ${configuredEmail}\n` +
      `ë§ˆì§€ë§‰ ì•Œë¦¼ ë°œì†¡: ${lastEmailDate}`
    );
    Logger.log("í…ŒìŠ¤íŠ¸ ì´ë©”ì¼ ë°œì†¡ ì„±ê³µ!");
    Browser.msgBox(`í…ŒìŠ¤íŠ¸ ì´ë©”ì¼ì´ ${configuredEmail}ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ë©”ì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.`);
  } catch (error) {
    Logger.log(`ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨: ${error.toString()}`);
    Browser.msgBox(`ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨: ${error.toString()}`);
  }
}

// ì„¤ì • ê°€ì´ë“œ í‘œì‹œ
function showSetupGuide() {
  const ui = SpreadsheetApp.getUi();
  const guide = `
ğŸŒ¡ï¸ ê¸°ìƒ ì•Œë¦¼ ì‹œìŠ¤í…œ ì„¤ì • ê°€ì´ë“œ (31ë„ ê¸°ì¤€)

ğŸ“§ ì´ë©”ì¼ ì„¤ì • ë°©ë²• (3ê°€ì§€ ì¤‘ íƒ1):
1. ìŠ¤í”„ë ˆë“œì‹œíŠ¸ K1 ì…€ì— ì´ë©”ì¼ ì…ë ¥ (ê°€ì¥ ì‰¬ì›€)
2. ì½”ë“œì—ì„œ NOTIFICATION_EMAIL ë³€ê²½
3. ë³„ë„ ì„¤ì • ì—†ì´ êµ¬ê¸€ ê³„ì • ì´ë©”ì¼ ì‚¬ìš©

ğŸŒ¡ï¸ ì•Œë¦¼ ê¸°ì¤€:
- ì²´ê°ì˜¨ë„ 31Â°C ì´ìƒ: 2ì‹œê°„ ê·¼ë¬´ì‹œ 10ë¶„ íœ´ì‹
- ì²´ê°ì˜¨ë„ 33Â°C ì´ìƒ: 2ì‹œê°„ ê·¼ë¬´ì‹œ 20ë¶„ íœ´ì‹

â° ë°œì†¡ ì£¼ê¸°:
- ë°ì´í„° ìˆ˜ì§‘: 10ë¶„ë§ˆë‹¤
- ì´ë©”ì¼ ë°œì†¡: 30ë¶„ ê°„ê²© (ì¤‘ë³µ ë°©ì§€)

âš™ï¸ ìë™ ì‹¤í–‰ ì„¤ì •:
- ë©”ë‰´ â†’ 'â° ìë™ ì‹¤í–‰ ì„¤ì •' í´ë¦­
- 10ë¶„ë§ˆë‹¤ ìë™ìœ¼ë¡œ ë‚ ì”¨ í™•ì¸
- ì¡°ê±´ ë§Œì¡±ì‹œ 30ë¶„ ê°„ê²©ìœ¼ë¡œ ì´ë©”ì¼ ì•Œë¦¼

ğŸ§ª í…ŒìŠ¤íŠ¸:
- ë©”ë‰´ â†’ 'ğŸ§ª í…ŒìŠ¤íŠ¸ ì´ë©”ì¼ ë°œì†¡' í´ë¦­
- ì‹¤ì œ ë‚ ì”¨ì™€ ê´€ê³„ì—†ì´ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥
- resetEmailTimer() í•¨ìˆ˜ë¡œ íƒ€ì´ë¨¸ ì´ˆê¸°í™” ê°€ëŠ¥

ğŸ“Š ë°ì´í„° ì •ë¦¬:
- 2ë…„ ì´ìƒ ëœ ë°ì´í„°ëŠ” ë§¤ì¼ ìƒˆë²½ 3ì‹œ ìë™ ì‚­ì œ
- í•„ìš”ì—†ìœ¼ë©´ cleanOldData íŠ¸ë¦¬ê±° ì‚­ì œ
`;

  ui.alert('ì„¤ì • ê°€ì´ë“œ', guide, ui.ButtonSet.OK);
}